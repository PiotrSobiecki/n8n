{
  "name": "moj asystent",
  "nodes": [
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-3.5-turbo",
          "mode": "list",
          "cachedResultName": "GPT-3.5-TURBO"
        },
        "responses": {
          "values": [
            {
              "content": "={{ $json.polaczonyTekst }}\n\nPowy≈ºej znajduje siƒô TRANSKRYPCJA g≈Çosowa z listƒÖ zakup√≥w.\nPracuj WY≈ÅƒÑCZNIE na tym tek≈õcie. Traktuj go jak \"prawdƒô objawionƒÖ\" ‚Äì nie poprawiaj go, nie domy≈õlaj siƒô, co u≈ºytkownik ‚Äûpewnie mia≈Ç na my≈õli‚Äù.\n\nTwoje zadanie:\n1. Rozpoznaj intencjƒô: DODANIE produkt√≥w czy USUNIƒòCIE produkt√≥w z listy zakup√≥w.\n2. Wyodrƒôbnij z transkrypcji wszystkie s≈Çowa/frazy, kt√≥re wyglƒÖdajƒÖ na nazwy produkt√≥w.\n3. Dla ka≈ºdego produktu spr√≥buj wyciƒÖgnƒÖƒá ilo≈õƒá, jednostkƒô, opis i ewentualne uwagi.\n\n**ROZPOZNAWANIE INTENCJI:**\n\n**INTENCJA: DODANIE produkt√≥w**\nJe≈õli wiadomo≈õƒá zawiera:\n- S≈Çowa: dodaj, kup, potrzebujƒô, chcƒô, lista zakup√≥w, zakupy\n- Wymienione produkty bez s≈Ç√≥w wskazujƒÖcych na usuniƒôcie\n- Brak s≈Ç√≥w wskazujƒÖcych na usuniƒôcie (usu≈Ñ, wykre≈õl, nie kupuj, nie potrzebujƒô, skre≈õl, usu≈Ñ z listy)\n\n**INTENCJA: USUNIƒòCIE produkt√≥w**\nJe≈õli wiadomo≈õƒá zawiera:\n- S≈Çowa: usu≈Ñ, wykre≈õl, skre≈õl, nie kupuj, nie potrzebujƒô, usu≈Ñ z listy, nie kupowaƒá, odwo≈Çaj\n- Wskazanie na produkty, kt√≥re majƒÖ byƒá usuniƒôte\n- Negacjƒô w kontek≈õcie zakup√≥w (np. \"nie kupuj chleba\", \"nie potrzebujƒô mleka\")\n\nDZIELENIE NA WIELE PRODUKT√ìW Z JEDNEGO ZDANIA:\n- Je≈õli w jednym zdaniu wystƒôpuje kilka produkt√≥w oddzielonych przecinkami lub sp√≥jnikami (\"i\", \"oraz\", \"lub\"), potraktuj KA≈ªDY z nich jako osobny produkt.\n- Przyk≈Çad:\n  Transkrypcja: \"Worki na ≈õmieci, gƒÖbki do mycia naczy≈Ñ.\"\n  Odpowied≈∫ MUSI zawieraƒá DWA produkty:\n\n  {\n    \"action\": \"add\",\n    \"products\": [\n      { \"lp\": 1, \"name\": \"worki na ≈õmieci\", \"quantity\": 1, \"unit\": \"szt\", \"description\": \"\", \"notes\": \"\" },\n      { \"lp\": 2, \"name\": \"gƒÖbki do mycia naczy≈Ñ\", \"quantity\": 1, \"unit\": \"szt\", \"description\": \"\", \"notes\": \"\" }\n    ],\n    \"summary\": \"Lista zakup√≥w: worki na ≈õmieci, gƒÖbki do mycia naczy≈Ñ\"\n  }\n\n- Przyk≈Çad USUWANIA:\n  Transkrypcja: \"Usu≈Ñ chleb i mleko z listy zakup√≥w.\"\n  Odpowied≈∫:\n\n  {\n    \"action\": \"remove\",\n    \"products\": [\n      { \"row_number\": 1, \"name\": \"chleb\", \"quantity\": 1, \"unit\": \"szt\", \"description\": \"\", \"notes\": \"\" },\n      { \"row_number\": 2, \"name\": \"mleko\", \"quantity\": 1, \"unit\": \"szt\", \"description\": \"\", \"notes\": \"\" }\n    ],\n    \"summary\": \"Usuniƒôcie z listy: chleb, mleko\"\n  }\n\n- NIE WOLNO pomijaƒá ≈ºadnego produktu, kt√≥ry wystƒôpuje w tek≈õcie, nawet je≈õli zdanie jest kr√≥tkie lub wyglƒÖda ma≈Ço ‚Äûtypowo‚Äù.\n\nBARDZO WA≈ªNE ZASADY (BEZWZGLƒòDNIE PRZESTRZEGAJ):\n- **NIE WOLNO** dodawaƒá produkt√≥w, kt√≥re NIE WYSTƒòPUJƒÑ jako s≈Çowa w transkrypcji.\n- Ka≈ºdy produkt w polu \"name\" musi mieƒá sw√≥j odpowiednik jako s≈Çowo/fraza w tek≈õcie wej≈õciowym.\n- **NIE WOLNO** zamieniaƒá jednego s≈Çowa na inne ‚Äûbardziej sensowne‚Äù.\n  - Je≈õli w tek≈õcie jest ‚ÄûMasuo‚Äù, to w JSON masz wpisaƒá `\"name\": \"Masuo\"`, a NIE ‚Äûmas≈Ço‚Äù.\n  - Je≈õli jakie≈õ s≈Çowo brzmi dziwnie albo nie jeste≈õ pewien, i tak wpisz je dok≈Çadnie tak, jak w transkrypcji (poza prostƒÖ normalizacjƒÖ do mianownika / liczby pojedynczej, ale bez zmiany rdzenia).\n- **NIE WOLNO** zgadywaƒá produkt√≥w ‚Äûz g≈Çowy\", na podstawie:\n  - typowych list zakup√≥w,\n  - zdrowego rozsƒÖdku,\n  - tego, co ‚Äûczƒôsto siƒô kupuje razem\".\n- Je≈õli w tek≈õcie jest tylko jedno dziwne s≈Çowo i nie wiesz, co to jest, potraktuj je jako nazwƒô produktu i wpisz je dok≈Çadnie tak, jak brzmi.\n- Je≈õli naprawdƒô nie znajdujesz ≈ºadnych oczywistych produkt√≥w, zwr√≥ƒá po prostu `\"products\": []`.\n\nZasady ekstrakcji:\n- Ka≈ºdy produkt powinien mieƒá unikalny numer porzƒÖdkowy (lp), zaczynajƒÖcy siƒô od 1 i rosnƒÖcy o 1.\n- Je≈õli produkt ma ilo≈õƒá (np. ‚Äû2 chleby\", ‚Äûkilogram mƒÖki\"), wyodrƒôbnij jƒÖ do `quantity`.\n- Je≈õli produkt ma jednostkƒô (np. ‚Äûkg\", ‚Äûszt\", ‚Äûlitr\"), wyodrƒôbnij jƒÖ do `unit`.\n- Je≈õli pojawiajƒÖ siƒô dodatkowe informacje (marka, rodzaj, smak itp.), wpisz je w `description`.\n- **UWAGI (notes)**: Je≈õli sƒÖ dodatkowe wskaz√≥wki typu ‚Äûkup w Lidlu\", ‚Äûnie kupuj jako UHT\", ‚Äûtylko marka Y\", przenie≈õ je do pola `notes`.\n\nZwr√≥ƒá WY≈ÅƒÑCZNIE poprawny JSON w formacie:\n\n{\n  \"action\": \"add\" | \"remove\",\n  \"products\": [\n    {\n      \"row_number\": 1,\n      \"name\": \"dok≈Çadna nazwa z transkrypcji (bez zgadywania)\",\n      \"quantity\": 2,\n      \"unit\": \"szt\",\n      \"description\": \"opcjonalny opis\",\n      \"notes\": \"opcjonalne uwagi (np. 'kup w lidlu', 'nie kupuj jako X')\"\n    }\n  ],\n  \"summary\": \"kr√≥tkie podsumowanie listy, bazujƒÖce wy≈ÇƒÖcznie na faktycznych produktach\"\n}\n\nDodatkowe zasady:\n- Pole `action` musi byƒá \"add\" (dodanie) lub \"remove\" (usuniƒôcie).\n- Je≈õli intencja jest niejasna, domy≈õlnie ustaw `action: \"add\"`.\n- Je≈õli ilo≈õƒá nie jest podana, ustaw `quantity: 1`.\n- Je≈õli jednostka nie jest podana, ustaw `unit: \"szt\"`.\n- Nazwƒô mo≈ºesz znormalizowaƒá do mianownika liczby pojedynczej (np. ‚Äûchleb\" zamiast ‚Äûchleby\"), ALE:\n  - nie zamieniaj s≈Çowa na inne (np. ‚ÄûMasuo\" NIE mo≈ºe staƒá siƒô ‚Äûmas≈Ço\").\n- Pole `notes` wype≈Çniaj tylko wtedy, gdy w transkrypcji sƒÖ wyra≈∫ne uwagi dotyczƒÖce zakupu.\n- NIE dodawaj ≈ºadnych komentarzy ani tekstu poza jednym obiektem JSON.\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -112,
        512
      ],
      "id": "c8468263-377b-4f35-ab06-de6077cf4794",
      "name": "OpenAI - Rozpoznaj intencjƒô",
      "credentials": {
        "openAiApi": {
          "id": "tieAhpOSBmQOrTPn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4",
          "mode": "list",
          "cachedResultName": "lista zakup√≥w",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "nazwa produktu": "={{ $json.name }}",
            "ilo≈õƒá": "={{ $json.quantity }} {{ $json.unit }}",
            "uwagi": "={{ $json.description }} {{ $json.notes }}",
            "status": "={{ $json.status || 'Nie kupione' }}"
          },
          "matchingColumns": [
            "nazwa produktu"
          ],
          "schema": [
            {
              "id": "nazwa produktu",
              "displayName": "nazwa produktu",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ilo≈õƒá",
              "displayName": "ilo≈õƒá",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "uwagi",
              "displayName": "uwagi",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "14193b60-a0fb-4cc9-970d-9df04a7add9d",
      "name": "Google Sheets - Zapisz zadania",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        928,
        576
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Parsuj odpowied≈∫ z OpenAI GPT i przygotuj dane do zapisania w Excelu (Google Sheets)\n * \n * Schemat kolumn w Excelu dla listy zakup√≥w:\n * - lp (numer porzƒÖdkowy)\n * - nazwa produktu\n * - ilo≈õƒá\n * - jednostka\n * - opis\n * - data\n * - status\n * - utworzono\n * \n * U≈ºycie w n8n Code node:\n * - Po≈ÇƒÖczenie: OpenAI GPT (Lista zakup√≥w) ‚Üí Parsuj listƒô zakup√≥w ‚Üí Google Sheets\n */\n\nconst inputItems = $input.all();\n\nfunction parseFromModelText(itemJson) {\n  // Sprawd≈∫ czy dane sƒÖ ju≈º obiektem JSON (np. z wƒôz≈Ça IF)\n  if (itemJson && typeof itemJson === 'object' && !Array.isArray(itemJson)) {\n    // Je≈õli ju≈º mamy obiekt z polami action, products, summary - u≈ºyj go bezpo≈õrednio\n    if (itemJson.action || itemJson.products || itemJson.summary) {\n      return itemJson;\n    }\n  }\n  \n  // Je≈õli nie, spr√≥buj wyciƒÖgnƒÖƒá z odpowiedzi GPT (langchain format)\n  let text = itemJson?.output?.[0]?.content?.[0]?.text || itemJson.text || itemJson;\n\n  // Je≈õli to ju≈º obiekt, zwr√≥ƒá go\n  if (typeof text === 'object' && text !== null) {\n    return text;\n  }\n\n  // Je≈õli to nie string, spr√≥buj sparsowaƒá jako JSON\n  if (typeof text !== \"string\") {\n    // Mo≈ºe to byƒá ju≈º sparsowany obiekt\n    if (typeof text === 'object') {\n      return text;\n    }\n    throw new Error(\"Nie znaleziono danych w odpowiedzi\");\n  }\n\n  // Wyczy≈õƒá tekst z markdown code blocks i znak√≥w nowej linii\n  text = text\n    .trim()\n    .replace(/^```(?:json)?\\s*/i, \"\")\n    .replace(/```$/i, \"\")\n    .replace(/\\\\n/g, '') // Usu≈Ñ litera≈Çy \\n\n    .trim();\n\n  // WyciƒÖgnij JSON z tekstu\n  const match = text.match(/\\{[\\s\\S]*\\}/);\n  if (!match) {\n    throw new Error(\"W tek≈õcie nie ma obiektu JSON\");\n  }\n\n  let jsonString = match[0];\n  \n  // Funkcja do naprawiania typowych b≈Çƒôd√≥w JSON\n  function fixJson(jsonStr) {\n    // Usu≈Ñ wszystkie \\n i rzeczywiste znaki nowej linii\n    jsonStr = jsonStr.replace(/\\\\n/g, '').replace(/\\n/g, '');\n    \n    // Napraw brakujƒÖce przecinki miƒôdzy zamykajƒÖcym nawiasem tablicy a nastƒôpnym polem\n    // Przyk≈Çad: ]\"summary\" -> ],\"summary\"\n    jsonStr = jsonStr.replace(/\\]\\s*\"/g, '], \"');\n    \n    // Napraw brakujƒÖce przecinki miƒôdzy warto≈õciami a nastƒôpnym polem\n    // Przyk≈Çad: \"\"notes\" -> \", \"notes\"\n    jsonStr = jsonStr.replace(/\"\"([a-zA-Z_])/g, '\", \"$1');\n    \n    // Napraw brakujƒÖce przecinki miƒôdzy polami (np. \"notes\" \"summary\" -> \"notes\", \"summary\")\n    jsonStr = jsonStr.replace(/\"\\s*\"([a-zA-Z_])/g, '\", \"$1');\n    \n    // Napraw brakujƒÖce przecinki w tablicach (np. }{ -> },{)\n    jsonStr = jsonStr.replace(/}\\s*{/g, '}, {');\n    \n    // Napraw brakujƒÖce przecinki miƒôdzy elementami tablicy\n    jsonStr = jsonStr.replace(/}\\s*]/g, '}]');\n    \n    // Napraw podw√≥jne przecinki\n    jsonStr = jsonStr.replace(/,\\s*,/g, ',');\n    \n    // Napraw przecinki przed zamykajƒÖcymi nawiasami (usu≈Ñ nadmiarowe)\n    jsonStr = jsonStr.replace(/,\\s*([}\\]])/g, '$1');\n    \n    return jsonStr;\n  }\n\n  let parsed;\n  try {\n    parsed = JSON.parse(jsonString);\n  } catch (parseError) {\n    // Spr√≥buj naprawiƒá JSON\n    let cleanedJson = fixJson(jsonString);\n    try {\n      parsed = JSON.parse(cleanedJson);\n    } catch (e) {\n      // Je≈õli nadal nie dzia≈Ça, spr√≥buj bardziej agresywne naprawy\n      try {\n        // Napraw konkretny przypadek: ]\"summary\" -> ],\"summary\"\n        cleanedJson = cleanedJson.replace(/\\]\\s*\"summary\"/g, '], \"summary\"');\n        // Napraw: \"\"notes\" -> \", \"notes\"\n        cleanedJson = cleanedJson.replace(/\"\"notes\"/g, '\", \"notes\"');\n        // Napraw: \"notes\" \"summary\" -> \"notes\", \"summary\"\n        cleanedJson = cleanedJson.replace(/\"notes\"\\s*\"summary\"/g, '\"notes\", \"summary\"');\n        \n        parsed = JSON.parse(cleanedJson);\n      } catch (e2) {\n        // Ostatnia pr√≥ba - wy≈õwietl szczeg√≥≈Çy b≈Çƒôdu dla debugowania\n        console.error('=== B≈ÅƒÑD PARSOWANIA JSON ===');\n        console.error('Oryginalny JSON (pierwsze 800 znak√≥w):', jsonString.substring(0, 800));\n        console.error('Naprawiony JSON (pierwsze 800 znak√≥w):', cleanedJson.substring(0, 800));\n        console.error('B≈ÇƒÖd pierwotny:', parseError.message);\n        console.error('B≈ÇƒÖd po naprawie:', e.message);\n        console.error('B≈ÇƒÖd po agresywnej naprawie:', e2.message);\n        \n        // Spr√≥buj znale≈∫ƒá problematyczne miejsce\n        const errorMatch = e2.message.match(/position (\\d+)/);\n        if (errorMatch) {\n          const pos = parseInt(errorMatch[1]);\n          const start = Math.max(0, pos - 50);\n          const end = Math.min(cleanedJson.length, pos + 50);\n          console.error('Problem w okolicy pozycji', pos, ':', cleanedJson.substring(start, end));\n        }\n        \n        throw new Error(`B≈ÇƒÖd parsowania JSON: ${parseError.message}. Szczeg√≥≈Çy w konsoli.`);\n      }\n    }\n  }\n\n  return parsed;\n}\n\nfunction normalizeProduct(product, summary, defaultDateStr, action) {\n  // Normalizuj lp (numer porzƒÖdkowy)\n  const lp = parseInt(product.lp) || 0;\n  \n  // Normalizuj nazwƒô produktu\n  const name = (product.name || '').trim() || 'Bez nazwy';\n  \n  // Normalizuj ilo≈õƒá\n  const quantity = parseFloat(product.quantity) || 1;\n  \n  // Normalizuj jednostkƒô\n  const unit = (product.unit || 'szt').trim().toLowerCase();\n  \n  // Normalizuj opis\n  const description = (product.description || '').trim();\n  \n  // Normalizuj uwagi (notes) - tylko je≈õli sƒÖ podane\n  const notes = (product.notes || product.uwagi || '').trim();\n  \n  return {\n    lp: lp,\n    name: name,\n    quantity: quantity,\n    unit: unit,\n    description: description,\n    notes: notes,\n    date: defaultDateStr,\n    status: 'Nie kupione',\n    created_at: new Date().toISOString(),\n    summary: summary,\n    action: action // Dodaj informacjƒô o akcji (add/remove)\n  };\n}\n\n// G≈Ç√≥wna logika parsowania\nconst output = [];\nlet allProductsData = []; // Zbierz wszystkie produkty do obliczenia statystyk\n\nfor (const item of inputItems) {\n  try {\n    const parsed = parseFromModelText(item.json);\n    const products = parsed.products || [];\n    const summary = parsed.summary || '';\n    \n    // Pobierz akcjƒô (add/remove) - domy≈õlnie 'add'\n    const action = parsed.action || 'add';\n    \n    // Pobierz datƒô dzisiejszƒÖ jako domy≈õlnƒÖ\n    const today = new Date();\n    const defaultDateStr = today.toISOString().split('T')[0]; // Format: yyyy-mm-dd\n    \n    // Przetw√≥rz ka≈ºdy produkt\n    for (const product of products) {\n      const normalizedProduct = normalizeProduct(product, summary, defaultDateStr, action);\n      allProductsData.push(normalizedProduct);\n    }\n    \n  } catch (error) {\n    throw new Error(`B≈ÇƒÖd parsowania produktu: ${error.message}. Dane: ${JSON.stringify(item.json).substring(0, 200)}`);\n  }\n}\n\nif (allProductsData.length === 0) {\n  throw new Error('Nie znaleziono ≈ºadnych produkt√≥w do zapisania');\n}\n\n// Oblicz statystyki\nconst totalProducts = allProductsData.length;\nconst totalQuantity = allProductsData.reduce((sum, product) => sum + (parseFloat(product.quantity) || 0), 0);\n\n// Sprawd≈∫ akcjƒô (je≈õli wszystkie produkty majƒÖ tƒô samƒÖ akcjƒô)\nconst action = allProductsData[0]?.action || 'add';\n\n// Dodaj statystyki do ka≈ºdego produktu (bƒôdƒÖ dostƒôpne w wiadomo≈õci Telegram)\nfor (const product of allProductsData) {\n  product.stats = {\n    totalProducts: totalProducts,\n    totalQuantity: totalQuantity,\n    action: action // Dodaj akcjƒô do statystyk\n  };\n  output.push({ json: product });\n}\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        480
      ],
      "id": "8b47eb5e-fa75-43b7-b118-840cf0447399",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "jsCode": "// Przygotuj jedno powiadomienie z ca≈ÇƒÖ listƒÖ produkt√≥w\n// Pobierz dane z wƒôz≈Ça parsujƒÖcego GPT (Code in JavaScript1), nie z Google Sheets\nconst allProducts = $('Code in JavaScript1').all();\n\nif (allProducts.length === 0) {\n  throw new Error('Brak produkt√≥w do wy≈õwietlenia');\n}\n\n// Debug - sprawd≈∫ strukturƒô danych\nconsole.log('Liczba produkt√≥w:', allProducts.length);\nconsole.log('Pierwszy produkt:', JSON.stringify(allProducts[0]?.json, null, 2));\n\n// Pobierz dane z pierwszego produktu (statystyki i podsumowanie)\nconst firstProduct = allProducts[0].json;\nconst summary = firstProduct.summary || '';\nconst totalProducts = firstProduct.stats?.totalProducts || allProducts.length;\nconst totalQuantity = firstProduct.stats?.totalQuantity || allProducts.reduce((sum, p) => sum + (parseFloat(p.json.quantity) || 0), 0);\n\n// Stw√≥rz listƒô produkt√≥w\nconst productsList = allProducts.map((item) => {\n  const product = item.json;\n  const lp = product.lp || 0;\n  // Sprawd≈∫ r√≥≈ºne mo≈ºliwe pola z nazwƒÖ\n  const name = (product.name || product['nazwa produktu'] || product.title || '').trim();\n  if (!name || name === '') {\n    console.log('Brak nazwy produktu:', JSON.stringify(product, null, 2));\n  }\n  const quantity = product.quantity || product.ilo≈õƒá || 1;\n  const unit = product.unit || product.jednostka || 'szt';\n  const description = (product.description || product.uwagi || '') ? ` (${product.description || product.uwagi || ''})` : '';\n  \n  return `${lp}. ${name || 'Bez nazwy'} - ${quantity} ${unit}${description}`;\n}).filter(item => item.trim() !== '').join('\\n');\n\n// Zwr√≥ƒá jedno powiadomienie z ca≈ÇƒÖ listƒÖ\nreturn [{\n  json: {\n    message: `‚úÖ Lista zakup√≥w zosta≈Ça utworzona w [Excelu](https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit?gid=0#gid=0)\\n\\nüìã Lista zakup√≥w:\\n${productsList}\\n\\nüìä Podsumowanie:\\n‚Ä¢ Liczba produkt√≥w: ${totalProducts}\\n‚Ä¢ ≈ÅƒÖczna ilo≈õƒá: ${totalQuantity}`,\n    summary: summary,\n    totalProducts: totalProducts,\n    totalQuantity: totalQuantity\n  }\n}];"
      },
      "id": "e2a9dfed-d01f-4afd-a8dc-2220c64e6633",
      "name": "Przygotuj powiadomienie",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        384
      ]
    },
    {
      "parameters": {
        "chatId": "-1001824126408",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "message_thread_id": 98
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1152,
        384
      ],
      "id": "6275baad-8fb5-42cf-a899-bd20db402d2e",
      "name": "Send a text message",
      "webhookId": "d9b6d266-f6d4-4390-bfe2-199001b5cab7",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -2272,
        384
      ],
      "id": "cbea224a-d2ec-40a3-8853-7f42935bfd6c",
      "name": "Telegram Trigger",
      "webhookId": "b948d641-fd4b-49e6-a89a-0031f2a9bc10",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parsuj odpowied≈∫ z rozpoznania intencji\n// Obs≈Çuguje intencje: complete_task, shopping_list, new_task\nconst item = $input.first();\nlet text = item.json?.output?.[0]?.content?.[0]?.text || item.json.text || '';\n\nif (typeof text !== \"string\") {\n  return [{ json: { intent: 'new_task', task_identifier: '', completed: false } }];\n}\n\ntext = text.trim().replace(/^```(?:json)?\\s*/i, '').replace(/```$/i, '').trim();\n\nconst match = text.match(/\\{[\\s\\S]*\\}/);\nif (!match) {\n  return [{ json: { intent: 'new_task', task_identifier: '', completed: false } }];\n}\n\ntry {\n  const parsed = JSON.parse(match[0]);\n  \n  // Walidacja intencji - obs≈Çugiwane warto≈õci: complete_task, shopping_list, new_task\n  const validIntents = ['complete_task', 'shopping_list', 'new_task'];\n  if (!parsed.intent || !validIntents.includes(parsed.intent)) {\n    // Je≈õli intencja nie jest rozpoznana, spr√≥buj odgadnƒÖƒá na podstawie zawarto≈õci\n    const lowerText = text.toLowerCase();\n    if (lowerText.includes('zakup') || lowerText.includes('kup') || lowerText.includes('lista zakup√≥w')) {\n      parsed.intent = 'shopping_list';\n    } else if (lowerText.includes('zrobione') || lowerText.includes('wykonane') || lowerText.includes('gotowe')) {\n      parsed.intent = 'complete_task';\n    } else {\n      parsed.intent = 'new_task';\n    }\n  }\n  \n  // Upewnij siƒô, ≈ºe wszystkie wymagane pola sƒÖ obecne\n  return [{ \n    json: {\n      intent: parsed.intent || 'new_task',\n      task_identifier: parsed.task_identifier || '',\n      completed: parsed.completed !== undefined ? parsed.completed : false\n    }\n  }];\n} catch (error) {\n  // W przypadku b≈Çƒôdu parsowania, zwr√≥ƒá domy≈õlnƒÖ intencjƒô\n  return [{ json: { intent: 'new_task', task_identifier: '', completed: false } }];\n}\n"
      },
      "id": "614b5f58-5472-4aca-83bf-5b76f3d18762",
      "name": "Parsuj intencjƒô",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        384
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "intent-check",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "complete_task",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e605be27-686c-4558-8adc-b5806bfe0902",
      "name": "Sprawd≈∫ intencjƒô",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -288,
        96
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "responses": {
          "values": [
            {
              "content": "={{ $('OpenAI - Transkrypcja g≈Çosu1').item.json.text }}\n\nPowy≈ºej znajduje siƒô lista zada≈Ñ lub zadanie nagrane g≈Çosowo. Przeanalizuj je i:\n1. Wyodrƒôbnij wszystkie zadania\n2. Oszacuj czas potrzebny na ka≈ºde zadanie\n3. Uwzglƒôdnij priorytety (je≈õli sƒÖ wspomniane)\n4. Stw√≥rz harmonogram na dzisiaj z konkretnymi godzinami\n5. Zwr√≥ƒá dane w formacie JSON:\n\n{\n  \"tasks\": [\n    {\n      \"id\": \"unique_id\",\n\"data\": \"data podana w transkrypcji, je≈õli nie zostaw puste\"\n      \"title\": \"Nazwa zadania\",\n      \"estimated_time\": 30,\n      \"priority\": \"high|medium|low\",\n      \"scheduled_time\": \"HH:MM\",\n      \"description\": \"Opis zadania\"\n    }\n  ],\n  \"summary\": \"Kr√≥tkie podsumowanie harmonogramu\"\n}\n\nZasady:\n- Czas w minutach\n- Harmonogram powinien byƒá realistyczny (uwzglƒôdnij przerwy 10-15 min miƒôdzy zadaniami)\n- Je≈õli nie podano czasu, oszacuj na podstawie typu zadania\n- Je≈õli nie podano priorytetu, ustaw 'medium'\n- Zaplanuj zadania od najbli≈ºszej godziny dostƒôpnej (sprawd≈∫ aktualnƒÖ godzinƒô)\n- Priorytet 'high' powinien byƒá zaplanowany wcze≈õniej\n- Zwr√≥ƒá wy≈ÇƒÖcznie poprawny JSON, bez dodatkowych opis√≥w.\n- ID zwracaƒá kolejny numer zadania \n- Je≈õli zostanie podana data zadania wpisz jƒÖ \n- Jesli zostanie podany czas na skonczenie wpisz go \n- Jesli zostanie podana godzina zakonczenia wpisz jƒÖ "
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "0b1dbd33-ec01-4be2-81fb-9139869adc33",
      "name": "OpenAI - Organizuj zadania",
      "credentials": {
        "openAiApi": {
          "id": "tieAhpOSBmQOrTPn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Przygotuj listƒô niezako≈Ñczonych zada≈Ñ do wys≈Çania do GPT\nconst allTasks = $input.all();\nconst transcribedText = $('Code in JavaScript2').first().json.text || '';\n\n// Filtruj tylko niezako≈Ñczone zadania\nconst pendingTasks = [];\nfor (const task of allTasks) {\n  const status = (task.json.Status || task.json.status || '').toLowerCase().trim();\n  // Pomi≈Ñ zako≈Ñczone zadania\n  if (status === 'completed' || status === 'wykonane' || status === 'zako≈Ñczone') {\n    continue;\n  }\n  \n  pendingTasks.push({\n    id: task.json.ID || task.json.id || '',\n    title: task.json['tytu≈Ç zadania'] || task.json.title || '',\n    description: task.json['opis zadania'] || task.json.description || '',\n    row_number: task.json.row_number || task.json.rowNumber\n  });\n}\n\nif (pendingTasks.length === 0) {\n  throw new Error('Nie znaleziono ≈ºadnych niezako≈Ñczonych zada≈Ñ');\n}\n\n// Zwr√≥ƒá dane do GPT\nreturn [{\n  json: {\n    transcribedText: transcribedText,\n    tasks: pendingTasks\n  }\n}];"
      },
      "id": "9b7133f6-ce13-4a3b-be50-ab9f33d12395",
      "name": "Przygotuj zadania do GPT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        192
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-3.5-turbo",
          "mode": "list"
        },
        "responses": {
          "values": [
            {
              "content": "={{ $json.transcribedText }}\n\nPowy≈ºej znajduje siƒô transkrypcja g≈Çosowej wiadomo≈õci o zako≈Ñczeniu zadania.\n\nPoni≈ºej lista wszystkich niezako≈Ñczonych zada≈Ñ z Excela:\n\n{{ JSON.stringify($json.tasks, null, 2) }}\n\nPrzeanalizuj transkrypcjƒô i znajd≈∫, kt√≥re zadania z listy zosta≈Çy zako≈Ñczone.\n\n**WA≈ªNE:**\n- Je≈õli transkrypcja zawiera: \"zako≈Ñcz wszystkie\", \"wszystko zrobione\", \"wszystkie zadania\", \"nie ma wiƒôcej zada≈Ñ\", \"wszystko gotowe\" - zwr√≥ƒá \"all\"\n- Je≈õli wskazuje na konkretne zadanie - zwr√≥ƒá jego row_number (liczba, nie string)\n- Je≈õli wskazuje na kilka konkretnych zada≈Ñ - zwr√≥ƒá listƒô ich row_number (liczby)\n\nZwr√≥ƒá wy≈ÇƒÖcznie JSON:\n\n{\n  \"task_row_numbers\": [row_number1, row_number2] lub \"all\",\n  \"confidence\": \"high|medium|low\"\n}\n\nPrzyk≈Çady:\n- Pojedyncze zadanie: {\"task_row_numbers\": [5], \"confidence\": \"high\"}\n- Wiele zada≈Ñ: {\"task_row_numbers\": [5, 7, 9], \"confidence\": \"high\"}\n- Wszystkie zadania: {\"task_row_numbers\": \"all\", \"confidence\": \"high\"}\n- Niepewno≈õƒá: {\"task_row_numbers\": [], \"confidence\": \"low\"}\n\n**UWAGA:**\n- row_number to liczba (np. 5, 7, 9), nie string\n- U≈ºywaj row_number z listy zada≈Ñ powy≈ºej\n- Je≈õli nie jeste≈õ pewien, zwr√≥ƒá confidence=\"low\"\n\nZwr√≥ƒá wy≈ÇƒÖcznie poprawny JSON, bez dodatkowych opis√≥w ani komentarzy.\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        576,
        192
      ],
      "id": "aeee412c-b64d-4118-9736-00e1812c1140",
      "name": "OpenAI - Znajd≈∫ zadanie po ID",
      "credentials": {
        "openAiApi": {
          "id": "tieAhpOSBmQOrTPn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Parsuj odpowied≈∫ GPT i znajd≈∫ zadania do zako≈Ñczenia (pojedyncze lub wszystkie)\n * U≈ºywa row_number zamiast ID\n * \n * U≈ºycie w n8n Code node:\n * - Po≈ÇƒÖczenie: OpenAI - Znajd≈∫ zadanie po row_number ‚Üí Parsuj row_number ‚Üí Update row in sheet\n */\n\n// Parsuj odpowied≈∫ GPT i znajd≈∫ zadania do zako≈Ñczenia\nconst gptResponse = $input.first().json;\nlet text = gptResponse?.output?.[0]?.content?.[0]?.text || gptResponse.text || '';\n\nif (typeof text !== \"string\") {\n  throw new Error('Nie znaleziono odpowiedzi z GPT');\n}\n\n// Wyczy≈õƒá tekst z markdown code blocks i znak√≥w nowej linii\ntext = text\n  .trim()\n  .replace(/^```(?:json)?\\s*/i, '')\n  .replace(/```$/i, '')\n  .replace(/\\\\n/g, '') // Usu≈Ñ litera≈Çy \\n\n  .trim();\n\n// Znajd≈∫ JSON w tek≈õcie (mo≈ºe byƒá wiele obiekt√≥w)\nconst match = text.match(/\\{[\\s\\S]*?\\}/);\nif (!match) {\n  throw new Error(`Nie znaleziono JSON w odpowiedzi GPT. Tekst: ${text.substring(0, 200)}`);\n}\n\nlet parsed;\ntry {\n  parsed = JSON.parse(match[0]);\n} catch (parseError) {\n  // Spr√≥buj naprawiƒá JSON - usu≈Ñ wszystkie \\n\n  let cleanedJson = match[0].replace(/\\\\n/g, '').replace(/\\n/g, '');\n  try {\n    parsed = JSON.parse(cleanedJson);\n  } catch (e) {\n    throw new Error(`B≈ÇƒÖd parsowania JSON: ${parseError.message}. Tekst: ${match[0].substring(0, 200)}`);\n  }\n}\n\n// Obs≈Çu≈º r√≥≈ºne formaty odpowiedzi (task_row_numbers, task_ids lub task_id dla kompatybilno≈õci)\nlet taskRowNumbers = [];\nif (parsed.task_row_numbers === 'all' || parsed.task_ids === 'all') {\n  // Wszystkie zadania\n  taskRowNumbers = 'all';\n} else if (Array.isArray(parsed.task_row_numbers)) {\n  // Nowy format - row_number jako liczby\n  taskRowNumbers = parsed.task_row_numbers.map(rn => parseInt(rn)).filter(rn => !isNaN(rn));\n} else if (Array.isArray(parsed.task_ids)) {\n  // Stary format - spr√≥buj u≈ºyƒá jako row_number (je≈õli sƒÖ liczby)\n  taskRowNumbers = parsed.task_ids.map(id => parseInt(id)).filter(rn => !isNaN(rn));\n} else if (parsed.task_id) {\n  // Stary format - pojedyncze ID\n  const rowNum = parseInt(parsed.task_id);\n  if (!isNaN(rowNum)) {\n    taskRowNumbers = [rowNum];\n  }\n}\n\nif (parsed.confidence === 'low' || (!taskRowNumbers || (Array.isArray(taskRowNumbers) && taskRowNumbers.length === 0))) {\n  throw new Error('GPT nie znalaz≈Ç zada≈Ñ z wystarczajƒÖcƒÖ pewno≈õciƒÖ');\n}\n\n// Znajd≈∫ zadania w li≈õcie wszystkich zada≈Ñ\nconst allTasks = $('Google Sheets - Pobierz wszystkie zadania').all();\nconst foundTasks = [];\n\nif (taskRowNumbers === 'all') {\n  // Zwr√≥ƒá wszystkie niezako≈Ñczone zadania\n  for (const task of allTasks) {\n    const status = (task.json.Status || task.json.status || '').toLowerCase().trim();\n    if (status !== 'completed' && status !== 'wykonane' && status !== 'zako≈Ñczone') {\n      foundTasks.push(task.json);\n    }\n  }\n} else {\n  // Znajd≈∫ konkretne zadania po row_number\n  for (const rowNumber of taskRowNumbers) {\n    for (const task of allTasks) {\n      const taskRowNum = parseInt(task.json.row_number || task.json.rowNumber || 0);\n      if (taskRowNum === rowNumber) {\n        foundTasks.push(task.json);\n        break;\n      }\n    }\n  }\n}\n\nif (foundTasks.length === 0) {\n  const availableRowNumbers = allTasks.map(t => t.json.row_number || t.json.rowNumber).filter(Boolean).join(', ');\n  throw new Error(`Nie znaleziono zada≈Ñ. Szukane row_number: ${Array.isArray(taskRowNumbers) ? taskRowNumbers.join(', ') : 'all'}. Dostƒôpne row_number: ${availableRowNumbers}`);\n}\n\n// Zwr√≥ƒá wszystkie znalezione zadania\nreturn foundTasks.map(task => ({ json: task }));\n"
      },
      "id": "f1281664-0b9a-4b6a-a4d5-658ca7737f14",
      "name": "Parsuj ID zadania",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        192
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs",
          "mode": "list",
          "cachedResultName": "zadania",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit#gid=0"
        },
        "options": {}
      },
      "id": "91d9abd8-ef2f-4fa6-8945-d6f721ede433",
      "name": "Google Sheets - Pobierz wszystkie zadania",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        64,
        192
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs",
          "mode": "list",
          "cachedResultName": "zadania",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "zako≈Ñczone",
            "row_number": "={{ $json.row_number }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "ID",
              "displayName": "ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "tytu≈Ç zadania",
              "displayName": "tytu≈Ç zadania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "czas wykoania",
              "displayName": "czas wykoania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "priorytet",
              "displayName": "priorytet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "godzina wykonania",
              "displayName": "godzina wykonania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "opis zadania",
              "displayName": "opis zadania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            },
            {
              "id": "Status",
              "displayName": "Status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1152,
        192
      ],
      "id": "206accbe-d673-400e-a206-9b23229ff4d3",
      "name": "Update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Sprawd≈∫ czy to g≈Çosowa wiadomo≈õƒá i przepu≈õƒá dalej\nconst item = $input.first();\n\n// Debug - zobacz co przychodzi\nconsole.log('Otrzymana wiadomo≈õƒá:', JSON.stringify(item.json, null, 2));\n\nconst message = item.json.message || item.json;\n\n// Sprawd≈∫ czy to g≈Çosowa wiadomo≈õƒá (voice)\nif (message.voice || message.audio) {\n  console.log('Znaleziono g≈ÇosowƒÖ wiadomo≈õƒá:', message.voice || message.audio);\n  return [item];\n}\n\n// Je≈õli nie jest g≈Çosowa, zwr√≥ƒá pustƒÖ tablicƒô (zatrzymaj przep≈Çyw)\nconsole.log('To nie jest g≈Çosowa wiadomo≈õƒá, pomijam');\nreturn [];"
      },
      "id": "b6b0660f-61dd-4c6a-9628-0636c9ea4796",
      "name": "Sprawd≈∫ czy to g≈Ços1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        384
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "id": "29884ad0-07cd-4605-9429-a97fbc9c092b",
      "name": "Telegram - Pobierz plik g≈Çosowy1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1824,
        384
      ],
      "webhookId": "5f12233a-86ac-4e12-a1db-2271f95bfbfe",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -1600,
        384
      ],
      "id": "6dfed71a-1625-4f56-9f2e-5b348b9e6730",
      "name": "OpenAI - Transkrypcja g≈Çosu1",
      "credentials": {
        "openAiApi": {
          "id": "tieAhpOSBmQOrTPn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "responses": {
          "values": [
            {
              "content": "={{ $json.text }}\n\n\nPowy≈ºej znajduje siƒô wiadomo≈õƒá g≈Çosowa. Rozpoznaj intencjƒô u≈ºytkownika:\n\n**INTENCJA 1: Oznaczenie zadania jako wykonane**\nJe≈õli wiadomo≈õƒá zawiera:\n- S≈Çowa wskazujƒÖce na zako≈Ñczenie: zrobione, wykonane, gotowe, sko≈Ñczone, uko≈Ñczone, done, zako≈Ñczone, uko≈Ñczy≈Çem, zrobi≈Çem, sko≈Ñczy≈Çem, zako≈Ñczy≈Çem, gotowe, zrobione, wykonane\n- Formy przesz≈Çe czasownik√≥w zwiƒÖzanych z dzia≈Çaniem (zrobi≈Çem X, uko≈Ñczy≈Çem Y, sko≈Ñczy≈Çem Z)\n- Wskazanie na konkretne zadanie, kt√≥re zosta≈Ço wykonane\n\nWtedy zwr√≥ƒá:\n{\n  \"intent\": \"complete_task\",\n  \"task_identifier\": \"tytu≈Ç lub nazwa zadania, kt√≥re zosta≈Ço wykonane (np. 'zadanie X', 'faktury', 'raport')\",\n  \"completed\": true\n}\n\n**INTENCJA 2: Dodanie produkt√≥w do listy zakup√≥w**\nJe≈õli wiadomo≈õƒá zawiera:\n- S≈Çowa: dodaj do listy zakup√≥w, lista zakup√≥w, zakupy, kup, kupiƒá, potrzebujƒô, chleb, mleko, mas≈Ço, jajka, owoce, warzywa, produkty spo≈ºywcze, produkty przemys≈Çowe\n- Wymienione produkty spo≈ºywcze lub przemys≈Çowe (np. chleb, mleko, jajka, papier toaletowy, myd≈Ço)\n- Pro≈õbƒô o dodanie produkt√≥w do zakup√≥w\n- Brak wskazania na zadania do wykonania\n\nWtedy zwr√≥ƒá:\n{\n  \"intent\": \"shopping_list\",\n  \"task_identifier\": \"\",\n  \"completed\": false\n}\n\n**INTENCJA 3: Usuniƒôcie produkt√≥w z listy zakup√≥w**\nJe≈õli wiadomo≈õƒá zawiera:\n- S≈Çowa: usu≈Ñ z listy, wykre≈õl, skre≈õl, usu≈Ñ zakupy, wyrzuƒá z listy, usu≈Ñ wszystko, wyczy≈õƒá listƒô, skasuj, wyma≈º\n- Pro≈õbƒô o usuniƒôcie konkretnych produkt√≥w z listy zakup√≥w (np. \"usu≈Ñ chleb z listy\", \"wykre≈õl mleko\")\n- Pro≈õbƒô o usuniƒôcie wszystkich produkt√≥w (np. \"usu≈Ñ wszystko z listy\", \"wyczy≈õƒá ca≈ÇƒÖ listƒô zakup√≥w\")\n- Informacjƒô ≈ºe produkty zosta≈Çy ju≈º kupione (np. \"kupi≈Çem chleb\", \"mam ju≈º mleko\")\n\nWtedy zwr√≥ƒá:\n{\n  \"intent\": \"shopping_list\",\n  \"task_identifier\": \"\",\n  \"completed\": false\n}\n\n**Uwaga:** Rozr√≥≈ºnij miƒôdzy:\n- \"shopping_list\" - dodawanie produkt√≥w (kup, potrzebujƒô, dodaj)\n- \"shopping_list_remove\" - usuwanie produkt√≥w (usu≈Ñ, wykre≈õl, skre≈õl, kupi≈Çem, mam ju≈º)\n\n**INTENCJA 4: Lista nowych zada≈Ñ do zaplanowania**\nJe≈õli wiadomo≈õƒá zawiera:\n- Listƒô zada≈Ñ do wykonania (np. 'muszƒô zrobiƒá X, Y, Z', 'dodaj mi zadanie do zrobienia na takƒÖ datƒô i taki temat')\n- Planowanie na dzisiaj/jutro/konkretnƒÖ datƒô\n- Nowe zadania do dodania z terminem wykonania\n- Brak wskazania na zako≈Ñczenie istniejƒÖcego zadania i brak produkt√≥w spo≈ºywczych/przemys≈Çowych\n\nWtedy zwr√≥ƒá:\n{\n  \"intent\": \"new_task\",\n  \"task_identifier\": \"\",\n  \"completed\": false\n}\n\n**WA≈ªNE:**\n- Je≈õli wiadomo≈õƒá zawiera BOTH (nowe zadania + oznaczenie wykonania), traktuj jako \"complete_task\" tylko je≈õli jest wyra≈∫ne wskazanie na zako≈Ñczenie konkretnego zadania\n- Je≈õli wiadomo≈õƒá zawiera produkty spo≈ºywcze/przemys≈Çowe i s≈Çowa zwiƒÖzane z zakupami, traktuj jako \"shopping_list\"\n- Je≈õli wiadomo≈õƒá zawiera zadania z datƒÖ/terminem wykonania, traktuj jako \"new_task\"\n- Je≈õli nie jeste≈õ pewien, ustaw intent=\"new_task\"\n- task_identifier powinien byƒá konkretny i jednoznaczny (tytu≈Ç zadania, nie og√≥lne s≈Çowa)\n\nZwr√≥ƒá wy≈ÇƒÖcznie poprawny JSON, bez dodatkowych opis√≥w, komentarzy ani markdown.\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        -1152,
        384
      ],
      "id": "33e8d6de-ea7e-403a-8582-b27fddb7b222",
      "name": "OpenAI - Rozpoznaj intencjƒô1",
      "credentials": {
        "openAiApi": {
          "id": "tieAhpOSBmQOrTPn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs",
          "mode": "list",
          "cachedResultName": "zadania",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID": "={{ $json.id }}",
            "tytu≈Ç zadania": "={{ $json.title }}",
            "czas wykoania": "={{ $json.estimated_time }}",
            "priorytet": "={{ $json.priority }}",
            "godzina wykonania": "={{ $json.scheduled_time }}",
            "opis zadania": "={{ $json.description }}",
            "data": "={{ $json.date }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ID",
              "displayName": "ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tytu≈Ç zadania",
              "displayName": "tytu≈Ç zadania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "czas wykoania",
              "displayName": "czas wykoania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priorytet",
              "displayName": "priorytet",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "godzina wykonania",
              "displayName": "godzina wykonania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "opis zadania",
              "displayName": "opis zadania",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "87bf195d-8e6f-4493-a9ad-5c7e81461d94",
      "name": "Google Sheets - Zapisz zadania1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        640,
        0
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Parsuj odpowied≈∫ z Whisper i wyciƒÖgnij tekst\n * Whisper zwraca tekst w polu 'text'\n * \n * U≈ºycie w n8n Code node:\n * - Wklej ten kod do wƒôz≈Ça Code\n * - Po≈ÇƒÖczenie: OpenAI Whisper ‚Üí Parsuj transkrypcjƒô ‚Üí OpenAI GPT\n */\n\nconst item = $input.first();\n\n// WyciƒÖgnij tekst z odpowiedzi Whisper\nlet transcribedText = '';\n\n// Whisper mo≈ºe zwr√≥ciƒá tekst w r√≥≈ºnych miejscach w zale≈ºno≈õci od wersji API\nif (item.json.text) {\n  transcribedText = item.json.text;\n} else if (item.json.data && item.json.data.text) {\n  transcribedText = item.json.data.text;\n} else if (typeof item.json === 'string') {\n  transcribedText = item.json;\n} else {\n  // Spr√≥buj znale≈∫ƒá tekst w strukturze\n  transcribedText = JSON.stringify(item.json);\n}\n\n// Upewnij siƒô ≈ºe to string\nif (typeof transcribedText !== 'string') {\n  transcribedText = String(transcribedText);\n}\n\n// Wyczy≈õƒá tekst\ntranscribedText = transcribedText.trim();\n\nif (!transcribedText) {\n  throw new Error('Nie znaleziono tekstu w odpowiedzi z Whisper');\n}\n\n// Zwr√≥ƒá tekst do dalszego przetwarzania\nreturn [{\n  json: {\n    text: transcribedText,\n    originalData: item.json\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        384
      ],
      "id": "bc5bc184-b3d6-4a17-b58b-1a9e6df0fec0",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Parsuj odpowied≈∫ z OpenAI GPT i przygotuj dane do zapisania w Excelu (Google Sheets)\n * \n * Schemat kolumn w Excelu:\n * - ID\n * - Tytu≈Ç\n * - Opis\n * - Szacowany czas (min)\n * - Priorytet\n * - Zaplanowana godzina\n * - Data\n * - Status\n * - Utworzono\n * \n * U≈ºycie w n8n Code node:\n * - Po≈ÇƒÖczenie: OpenAI GPT (Organizuj zadania) ‚Üí Parsuj zadania ‚Üí Google Sheets\n */\n\nconst inputItems = $input.all();\n\nfunction parseFromModelText(itemJson) {\n  // WyciƒÖgnij tekst z odpowiedzi GPT (langchain format)\n  let text = itemJson?.output?.[0]?.content?.[0]?.text || itemJson.text || '';\n\n  if (typeof text !== \"string\") {\n    throw new Error(\"Nie znaleziono tekstu w output[0].content[0].text\");\n  }\n\n  // Wyczy≈õƒá tekst z markdown code blocks\n  text = text\n    .trim()\n    .replace(/^```(?:json)?\\s*/i, \"\")\n    .replace(/```$/i, \"\")\n    .trim();\n\n  // WyciƒÖgnij JSON z tekstu\n  const match = text.match(/\\{[\\s\\S]*\\}/);\n  if (!match) {\n    throw new Error(\"W tek≈õcie nie ma obiektu JSON\");\n  }\n\n  return JSON.parse(match[0]);\n}\n\nfunction parseDate(dateString) {\n  if (!dateString) {\n    return null;\n  }\n\n  // Je≈õli data jest ju≈º w formacie yyyy-mm-dd\n  if (typeof dateString === 'string' && dateString.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\n    return dateString;\n  }\n\n  // Format DD.MM.YYYY (np. 23.01.2026)\n  const ddmmyyyy = dateString.match(/^(\\d{1,2})\\.(\\d{1,2})\\.(\\d{4})$/);\n  if (ddmmyyyy) {\n    const day = ddmmyyyy[1].padStart(2, '0');\n    const month = ddmmyyyy[2].padStart(2, '0');\n    const year = ddmmyyyy[3];\n    return `${year}-${month}-${day}`;\n  }\n\n  // Format DD/MM/YYYY\n  const ddmmyyyySlash = dateString.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})$/);\n  if (ddmmyyyySlash) {\n    const day = ddmmyyyySlash[1].padStart(2, '0');\n    const month = ddmmyyyySlash[2].padStart(2, '0');\n    const year = ddmmyyyySlash[3];\n    return `${year}-${month}-${day}`;\n  }\n\n  // Spr√≥buj sparsowaƒá jako Date object\n  try {\n    const dateObj = new Date(dateString);\n    if (!isNaN(dateObj.getTime())) {\n      return dateObj.toISOString().split('T')[0];\n    }\n  } catch (e) {\n    // Ignoruj b≈Çƒôdy parsowania\n  }\n\n  return null;\n}\n\nfunction normalizeTask(task, summary, defaultDateStr) {\n  // Generuj unikalne ID je≈õli nie ma\n  const id = task.id || `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n  \n  // Normalizuj priorytet\n  let priority = (task.priority || 'medium').toLowerCase();\n  if (!['high', 'medium', 'low'].includes(priority)) {\n    priority = 'medium';\n  }\n  \n  // Normalizuj czas (upewnij siƒô ≈ºe to liczba)\n  const estimatedTime = parseInt(task.estimated_time) || 30;\n  \n  // Normalizuj godzinƒô (format HH:MM)\n  let scheduledTime = task.scheduled_time || '';\n  if (scheduledTime && !scheduledTime.match(/^\\d{2}:\\d{2}$/)) {\n    // Spr√≥buj sparsowaƒá r√≥≈ºne formaty czasu\n    const timeMatch = scheduledTime.match(/(\\d{1,2}):?(\\d{2})?/);\n    if (timeMatch) {\n      const hours = timeMatch[1].padStart(2, '0');\n      const minutes = (timeMatch[2] || '00').padStart(2, '0');\n      scheduledTime = `${hours}:${minutes}`;\n    }\n  }\n  \n  // Normalizuj datƒô\n  // WARUNEK: Je≈õli w transkrypcji (zadaniu) jest data - u≈ºyj jej, w przeciwnym razie u≈ºyj dzisiejszej daty\n  let taskDate = defaultDateStr; // Domy≈õlna data = dzisiaj (u≈ºywana gdy brak daty w transkrypcji)\n  \n  // Sprawd≈∫ pole 'data' lub 'date' w zadaniu z transkrypcji\n  const dateFromTask = task.data || task.date;\n  if (dateFromTask) {\n    const parsedDate = parseDate(dateFromTask);\n    if (parsedDate) {\n      // Je≈õli data z transkrypcji jest poprawna - u≈ºyj jej\n      taskDate = parsedDate;\n    }\n    // Je≈õli nie uda≈Ço siƒô sparsowaƒá daty z transkrypcji, pozostaw domy≈õlnƒÖ (dzisiejszƒÖ) datƒô\n  }\n  // Je≈õli w og√≥le nie ma daty w transkrypcji, pozostaje domy≈õlna (dzisiejsza) data\n  \n  return {\n    id: id,\n    title: (task.title || '').trim() || 'Bez tytu≈Çu',\n    description: (task.description || '').trim(),\n    estimated_time: estimatedTime,\n    priority: priority,\n    scheduled_time: scheduledTime,\n    date: taskDate,\n    status: 'pending',\n    created_at: new Date().toISOString(),\n    summary: summary\n  };\n}\n\n// G≈Ç√≥wna logika parsowania\nconst output = [];\nlet allTasksData = []; // Zbierz wszystkie zadania do obliczenia statystyk\n\nfor (const item of inputItems) {\n  try {\n    const parsed = parseFromModelText(item.json);\n    const tasks = parsed.tasks || [];\n    const summary = parsed.summary || '';\n    \n    // Pobierz datƒô dzisiejszƒÖ jako domy≈õlnƒÖ (tylko je≈õli zadanie nie ma w≈Çasnej daty)\n    const today = new Date();\n    const defaultDateStr = today.toISOString().split('T')[0]; // Format: yyyy-mm-dd\n    \n    // Przetw√≥rz ka≈ºde zadanie\n    for (const task of tasks) {\n      const normalizedTask = normalizeTask(task, summary, defaultDateStr);\n      allTasksData.push(normalizedTask);\n    }\n    \n  } catch (error) {\n    throw new Error(`B≈ÇƒÖd parsowania zadania: ${error.message}. Dane: ${JSON.stringify(item.json).substring(0, 200)}`);\n  }\n}\n\nif (allTasksData.length === 0) {\n  throw new Error('Nie znaleziono ≈ºadnych zada≈Ñ do zapisania');\n}\n\n// Oblicz statystyki\nconst totalTasks = allTasksData.length;\nconst totalTime = allTasksData.reduce((sum, task) => sum + (parseInt(task.estimated_time) || 0), 0);\n\n// Dodaj statystyki do ka≈ºdego zadania (bƒôdƒÖ dostƒôpne w wiadomo≈õci Telegram)\nfor (const task of allTasksData) {\n  task.stats = {\n    totalTasks: totalTasks,\n    totalTime: totalTime,\n    summary: allTasksData[0].summary || ''\n  };\n  output.push({ json: task });\n}\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        0
      ],
      "id": "5b25cc79-9984-41f5-a154-4f3b4fd33c7a",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "chatId": "-1001824126408",
        "text": "=‚úÖ Wszystkie zadania zosta≈Çy dodane do [Excela!](https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit?gid=0#gid=0)\n\nüìã Harmonogram:\n{{ $json['tytu≈Ç zadania'] }}\n\nüìä Podsumowanie:\n‚Ä¢ Liczba zada≈Ñ: {{ $('Code in JavaScript3').item.json.stats.totalTasks }}\n‚Ä¢ ≈ÅƒÖczny czas:  {{ $('Code in JavaScript3').item.json.stats.totalTime }} minut\n\n‚è∞ Przypomnienia bƒôdƒÖ wysy≈Çane 10 minut przed ka≈ºdym zadaniem.\n",
        "additionalFields": {
          "message_thread_id": 35
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        928,
        0
      ],
      "id": "3dd9c846-de21-4a13-8fed-d0eadbbd82a8",
      "name": "Send a text message1",
      "webhookId": "d9b6d266-f6d4-4390-bfe2-199001b5cab7",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "8394bd46-426c-443d-b693-00b8fffde141",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "shopping_list",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -624,
        384
      ],
      "id": "683dd756-7be3-4803-94ad-3a18832f1bab",
      "name": "If"
    },
    {
      "parameters": {
        "chatId": "-1001824126408",
        "text": "=‚úÖ Zadanie {{ $('Parsuj ID zadania').item.json['tytu≈Ç zadania'] }} zosta≈Ço oznaczone jako zako≈Ñczone w pliku [Excel](https://docs.google.com/spreadsheets/d/11R8VMzsNy5LSdsL_6TRjbKXRGt6Xqt1EnbC7K_9OKSs/edit?gid=0#gid=0)",
        "additionalFields": {
          "message_thread_id": 35
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1376,
        192
      ],
      "id": "6e09242f-96cb-4d1f-95fb-ebdb26d1e0e4",
      "name": "Send a text message2",
      "webhookId": "d9b6d266-f6d4-4390-bfe2-199001b5cab7",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "a02953e4-6858-4f6a-bb49-553e3cf6e577",
              "leftValue": "={{ $json.action }}",
              "rightValue": "remove",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        416,
        592
      ],
      "id": "1d3b0eae-8207-4f26-ac82-a202afedea09",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "// Parsuj odpowied≈∫ z OpenAI GPT dla listy zakup√≥w\n// Obs≈Çuguje akcje: add (dodanie produkt√≥w), remove (usuniƒôcie produkt√≥w)\nconst item = $input.first();\nlet text = item.json?.output?.[0]?.content?.[0]?.text || item.json.text || '';\n\nif (typeof text !== \"string\") {\n  return [{ json: { action: 'add', products: [], summary: 'B≈ÇƒÖd: nie znaleziono tekstu w odpowiedzi' } }];\n}\n\n// Wyczy≈õƒá tekst z markdown code blocks\ntext = text.trim().replace(/^```(?:json)?\\s*/i, '').replace(/```$/i, '').trim();\n\n// WyciƒÖgnij JSON z tekstu\nconst match = text.match(/\\{[\\s\\S]*\\}/);\nif (!match) {\n  return [{ json: { action: 'add', products: [], summary: 'B≈ÇƒÖd: nie znaleziono JSON w odpowiedzi' } }];\n}\n\ntry {\n  const parsed = JSON.parse(match[0]);\n  \n  // Walidacja akcji - obs≈Çugiwane warto≈õci: add, remove\n  const validActions = ['add', 'remove'];\n  if (!parsed.action || !validActions.includes(parsed.action)) {\n    const lowerText = text.toLowerCase();\n    if (lowerText.includes('usu≈Ñ') || lowerText.includes('wykre≈õl') || lowerText.includes('skre≈õl') || \n        lowerText.includes('nie kupuj') || lowerText.includes('nie potrzebujƒô') || \n        lowerText.includes('usu≈Ñ z listy') || lowerText.includes('odwo≈Çaj')) {\n      parsed.action = 'remove';\n    } else {\n      parsed.action = 'add';\n    }\n  }\n  \n  // Walidacja i normalizacja produkt√≥w\n  const products = (parsed.products || []).map((product, index) => {\n    // U≈ºyj row_number z GPT, je≈õli istnieje, inaczej oblicz z lp\n    const rowNumber = product.row_number || product.rowNumber || (product.lp ? product.lp + 1 : index + 2);\n    const lp = product.lp || product.row_number || (index + 1);\n    \n    return {\n      lp: lp,\n      row_number: rowNumber,\n      rowNumber: rowNumber,\n      name: (product.name || '').trim() || `Produkt ${index + 1}`,\n      quantity: parseInt(product.quantity) || 1,\n      unit: (product.unit || 'szt').trim(),\n      description: (product.description || '').trim(),\n      notes: (product.notes || '').trim()\n    };\n  });\n  \n  // Oblicz min/max row_number do usuwania wielu wierszy\n  const allRowNumbers = products.map(p => p.row_number);\n  const minRowNumber = allRowNumbers.length > 0 ? Math.min(...allRowNumbers) : 0;\n  const maxRowNumber = allRowNumbers.length > 0 ? Math.max(...allRowNumbers) : 0;\n  \n  return [{ \n    json: {\n      action: parsed.action || 'add',\n      products: products,\n      summary: (parsed.summary || '').trim() || `${parsed.action === 'remove' ? 'Usuniƒôcie' : 'Dodanie'} ${products.length} produkt${products.length !== 1 ? '√≥w' : 'u'}`,\n      // Dodatkowe pola do usuwania\n      startRowNumber: minRowNumber,\n      endRowNumber: maxRowNumber,\n      rowsCount: products.length,\n      allRowNumbers: allRowNumbers\n    }\n  }];\n} catch (error) {\n  console.error('B≈ÇƒÖd parsowania JSON:', error.message);\n  return [{ \n    json: { \n      action: 'add', \n      products: [], \n      summary: `B≈ÇƒÖd parsowania: ${error.message}`,\n      startRowNumber: 0,\n      endRowNumber: 0,\n      rowsCount: 0,\n      allRowNumbers: []\n    } \n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        512
      ],
      "id": "c3e2ae3c-fc12-4b7b-a534-54357ef7e03e",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "delete",
        "documentId": {
          "__rl": true,
          "value": "1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4",
          "mode": "list",
          "cachedResultName": "lista zakup√≥w",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit#gid=0"
        },
        "startIndex": "={{ $json.startRowNumber }}",
        "numberToDelete": "={{ $json.rowsCount }}"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        688,
        720
      ],
      "id": "0d5ef8cc-7ae2-4b76-91a3-8b90916f917a",
      "name": "Delete rows or columns from sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "chatId": "-1001824126408",
        "text": "=‚ùå Artyku≈Ç(y) \n\n{{ $json.lista }} \n\nzosta≈Ç(y) pomy≈õlnie usuniƒôty(e) z listy zakup√≥w.",
        "additionalFields": {
          "parse_mode": "=Markdown",
          "message_thread_id": 98
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1152,
        768
      ],
      "id": "46d389d3-5969-4add-b020-16547b5b052c",
      "name": "Send a text message3",
      "webhookId": "d9b6d266-f6d4-4390-bfe2-199001b5cab7",
      "credentials": {
        "telegramApi": {
          "id": "RYqcsiYsOxexfR4U",
          "name": "Telegram account moj asystent"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4",
          "mode": "list",
          "cachedResultName": "lista zakup√≥w",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Arkusz1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Xtq-ZV8jDUnZkqCeTt5cmniAiregV9iGRulUyq19Zl4/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -448,
        496
      ],
      "id": "70c19a45-3552-4574-a98d-f4ae89c7a829",
      "name": "Get row(s) in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "FB1poHZRQGWU0JyZ",
          "name": "Google Sheets moj asystent"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const allRows = $input.all();\n\n// Stw√≥rz listƒô tekstowƒÖ z row_number\nconst lista = allRows.map(item => {\n  const rowNum = item.json.row_number;\n  const nazwa = item.json[\"nazwa produktu\"];\n  const ilosc = item.json[\"ilo≈õƒá\"];\n  const status = item.json.status;\n  return `${rowNum}. ${nazwa} - ${ilosc} (${status})`;\n}).join('\\n');\n\nconst poprzedniTekst = $('Code in JavaScript2').first().json.originalData.text;\n\nreturn {\n  json: {\n    lista: lista,\n    poprzedniTekst: poprzedniTekst,\n    polaczonyTekst: `${poprzedniTekst}\\n\\n${lista}`\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        576
      ],
      "id": "0955f61f-de4f-48ed-b09d-9c4007dfdfe2",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "jsCode": "const summary = $('Code in JavaScript').first().json.summary;\n\n// Usu≈Ñ prefix \"Usuniƒôcie z listy:\" i podziel po przecinkach\nconst cleanText = summary.replace(/^.*?:\\s*/, ''); // Usuwa wszystko do dwukropka\nconst items = cleanText.split(',').map(item => item.trim());\n\n// Stw√≥rz numerowanƒÖ listƒô\nconst lista = items.map((item, index) => `${index + 1}. ${item}`).join('\\n');\n\nreturn {\n  json: {\n    lista: lista\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        736
      ],
      "id": "52644108-c35f-4a3e-b4c4-a6ea38983df8",
      "name": "Code in JavaScript5"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI - Rozpoznaj intencjƒô": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Przygotuj powiadomienie": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Google Sheets - Zapisz zadania",
            "type": "main",
            "index": 0
          },
          {
            "node": "Przygotuj powiadomienie",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Sprawd≈∫ czy to g≈Ços1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsuj intencjƒô": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sprawd≈∫ intencjƒô": {
      "main": [
        [
          {
            "node": "Google Sheets - Pobierz wszystkie zadania",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OpenAI - Organizuj zadania",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Organizuj zadania": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Przygotuj zadania do GPT": {
      "main": [
        [
          {
            "node": "OpenAI - Znajd≈∫ zadanie po ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Znajd≈∫ zadanie po ID": {
      "main": [
        [
          {
            "node": "Parsuj ID zadania",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsuj ID zadania": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets - Pobierz wszystkie zadania": {
      "main": [
        [
          {
            "node": "Przygotuj zadania do GPT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sprawd≈∫ czy to g≈Ços1": {
      "main": [
        [
          {
            "node": "Telegram - Pobierz plik g≈Çosowy1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram - Pobierz plik g≈Çosowy1": {
      "main": [
        [
          {
            "node": "OpenAI - Transkrypcja g≈Çosu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Transkrypcja g≈Çosu1": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Rozpoznaj intencjƒô1": {
      "main": [
        [
          {
            "node": "Parsuj intencjƒô",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets - Zapisz zadania1": {
      "main": [
        [
          {
            "node": "Send a text message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "OpenAI - Rozpoznaj intencjƒô1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Google Sheets - Zapisz zadania1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sprawd≈∫ intencjƒô",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Send a text message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Delete rows or columns from sheet",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete rows or columns from sheet": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet1": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "OpenAI - Rozpoznaj intencjƒô",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "Send a text message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "befea8ae-f016-49f0-9aa3-c39f96daff65",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "36c1969345fc1ddf302b7bbacc043da804ffaa31330036d1a88af5ddcc3a4146"
  },
  "id": "19J1qChtn1izC1XMrFB5B",
  "tags": []
}